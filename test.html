<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beyond All Reason - Map Popularity Stats for the Last 60 Days</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    th {
      background-color: #f2f2f2;
    }
    .loading-message {
      font-size: 1.2em;
      color: #555;
      text-align: center;
      margin-top: 20px;
    }
    .filter-section {
      margin-bottom: 20px;
    }
    .total-matches-column {
      background-color: #ffeeba;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Beyond All Reason - Map Popularity Stats for the Last 60 Days</h1>
  <div><a href="https://github.com/Dazazzell/barmaps/">https://github.com/Dazazzell/barmaps/</a></div>
  <div><a href="lobbycommands.html">BAR Lobby commands dump</a></div>
  
  <div class="filter-section">
    <label for="gameTypeSelect">Filter by Game Type:</label>
    <select id="gameTypeSelect">
      <option value="all" selected>All Game Types</option>
    </select>
  </div>

  <div id="loadingMessage" class="loading-message">Slowly loading and processing data, please wait...</div>
  <div id="lastMatchDate" class="loading-message" style="display: none;"></div>

  <table id="mapPlayerTable" style="display:none;">
    <thead>
      <tr>
        <th>Map</th>
        <th class="total-matches-column">Number of Matches</th>
        <!-- Player count columns will be added dynamically -->
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let mapCounts = {};  // Aggregates matches by map and player count
    let playerCounts = new Set();  // Tracks distinct player counts
    let filteredGameType = 'all';  // Default filter

    async function fetchAndParseCSV(url, callback) {
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Network response was not ok: ${response.statusText}`);
        }

        const arrayBuffer = await response.arrayBuffer();
        const decompressed = pako.ungzip(new Uint8Array(arrayBuffer), { to: 'string' });

        Papa.parse(decompressed, {
          header: true,
          complete: (result) => callback(result.data),
          error: (error) => {
            console.error('Error parsing CSV:', error);
            document.body.insertAdjacentHTML('beforeend', `<p>Error parsing CSV: ${error.message}</p>`);
          }
        });
      } catch (error) {
        console.error('Error fetching or processing data:', error);
        document.body.insertAdjacentHTML('beforeend', `<p>Error fetching or processing data: ${error.message}</p>`);
      }
    }

    function filterAndCountMatchesByDate(data) {
      const sixtyDaysAgo = new Date();
      sixtyDaysAgo.setDate(sixtyDaysAgo.getDate() - 60);

      data.forEach(row => {
        const gameDate = new Date(row.start_time);
        if (gameDate >= sixtyDaysAgo) {
          const map = row.map;
          const playerCount = parseInt(row.player_count, 10);  // Assuming player_count exists
          playerCounts.add(playerCount);  // Track distinct player counts

          if (!mapCounts[map]) {
            mapCounts[map] = { totalMatches: 0 };  // Initialize if new map
          }

          mapCounts[map].totalMatches++;
          mapCounts[map][`gamesWith${playerCount}Players`] = (mapCounts[map][`gamesWith${playerCount}Players`] || 0) + 1;
        }
      });
    }

    function populateGameTypeSelect(matches) {
      const gameTypes = new Set(matches.map(match => match.game_type));
      const gameTypeSelect = document.getElementById('gameTypeSelect');
      
      gameTypes.forEach(gameType => {
        const option = document.createElement('option');
        option.value = gameType;
        option.textContent = gameType;
        gameTypeSelect.appendChild(option);
      });
    }

    function displayTable(mapCounts, playerCounts) {
      const tableBody = document.getElementById('mapPlayerTable').getElementsByTagName('tbody')[0];
      const tableHead = document.getElementById('mapPlayerTable').getElementsByTagName('thead')[0];

      playerCounts.sort((a, b) => b - a);  // Sort player counts in descending order
      
      tableHead.innerHTML = `<tr>
        <th>Map</th>
        <th class="total-matches-column">Number of Matches</th>
        ${playerCounts.map(count => `<th>Games with ${count} Players</th>`).join('')}
      </tr>`;

      tableBody.innerHTML = '';  // Clear any existing rows

      // Convert mapCounts to an array and sort by total matches
      const countArray = Object.entries(mapCounts).sort((a, b) => b[1].totalMatches - a[1].totalMatches);

      countArray.forEach(([map, counts], index) => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${index + 1}. ${map}</td>
                         <td class="total-matches-column">${counts.totalMatches}</td>
                         ${playerCounts.map(count => `<td>${counts[`gamesWith${count}Players`] || 0}</td>`).join('')}`;
        tableBody.appendChild(row);
      });

      // Show table and hide loading message
      document.getElementById('loadingMessage').style.display = 'none';
      document.getElementById('mapPlayerTable').style.display = 'table';
    }

    function fetchData() {
      document.getElementById('loadingMessage').style.display = 'block';  // Show loading message
      document.getElementById('mapPlayerTable').style.display = 'none';  // Hide table initially
      document.getElementById('lastMatchDate').style.display = 'none';  // Hide last match date initially

      fetchAndParseCSV('https://data-marts.beyondallreason.dev/matches.csv.gz', (data) => {
        filterAndCountMatchesByDate(data);  // Aggregate match counts
        displayTable(mapCounts, Array.from(playerCounts));  // Display results in table
      });
    }

    // Event listener for game type filter
    document.getElementById('gameTypeSelect').addEventListener('change', function() {
      filteredGameType = this.value;
      // Update display based on selected game type if necessary
    });

    fetchData();  // Initial data fetch on page load
  </script>
</body>
</html>
